#
# Copyright (c) 2025-2026 LWB1978 <https://github.com/lwb1978>
# Description: Auto Cache Software Release JSONs
#
name: Auto Cache Software Release JSONs

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  cache_json:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Initialization environment
        run: |
          sudo timedatectl set-timezone "$TZ"

      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh

      - name: Fetch GitHub release JSONs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p output old_json

          declare -A repos
          repos["geoview"]="snowie2000/geoview"
          repos["chinadns-ng"]="zfl9/chinadns-ng"
          repos["xray"]="XTLS/Xray-core"
          repos["sing-box"]="SagerNet/sing-box"
          repos["hysteria"]="HyNetwork/hysteria"

          echo "Downloading previous api-cache release assets (if exists)..."
          gh release download api-cache --dir old_json --pattern "*.json" || echo "No previous release found"

          for name in "${!repos[@]}"; do
            repo="${repos[$name]}"
            echo "Processing $name from $repo ..."

            for t in release pre-release; do
              old="old_json/${name}-${t}-api.json"
              if [ -f "$old" ]; then
                cp "$old" "output/${name}-${t}-api.json.bak"
              fi
            done

            curl -sL "https://api.github.com/repos/$repo/releases/latest" -o "output/${name}-release-api.json"
            curl -sL "https://api.github.com/repos/$repo/releases?per_page=1" -o "output/${name}-pre-release-api.json"

            for t in release pre-release; do
              file="output/${name}-${t}-api.json"

              TAG_NAME=$(grep -oP '"tag_name": "\K[^"]+' "$file" || true)

              if [ -z "$TAG_NAME" ]; then
                echo "❌ ${file} No tag_name, restore old files..."
                rm -f "$file"

                if [ -f "${file}.bak" ]; then
                  mv "${file}.bak" "$file"
                fi
              else
                echo "✅ ${file} Verification successful, delete bak."
                rm -f "${file}.bak"
              fi
            done
          done

      - name: Check output directory
        id: check_output
        run: |
          if [ -z "$(ls -A output 2>/dev/null)" ]; then
            echo "empty=true" >> $GITHUB_OUTPUT
            echo "⚠️ The output directory is empty, and subsequent Upload/Release steps will be skipped."
          else
            echo "empty=false" >> $GITHUB_OUTPUT
            echo "✔ The output directory contains files."
          fi

      - name: Delete old release and tag
        if: steps.check_output.outputs.empty == 'false'
        run: |
          gh release delete api-cache --cleanup-tag -y || echo "No existing release to delete."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to release
        if: steps.check_output.outputs.empty == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: api-cache
          name: Software Release API Cache
          files: output/*.json
          body: |
            This release contains cached GitHub Release API JSON data for several software projects.  
            It is used by the PassWall (and PassWall2) update component to reduce reliance on GitHub's rate-limited API (60 requests per IP per hour).  
            
            **Please do not download it – it is of no use to you.**
            **请不要下载它，因为它对你没有任何用处。**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 5
          delete_workflow_pattern: 'Auto Cache Software Release JSONs'
